
\chapter{Special Elements} \label{SpecElem}

One advantage of SixTrack, that has been adopted from RACETRACK, is that it easily allows to define elements for a specific purpose. The special elements implemented till now are found in this section.
All Special Elements should be written in the \texttt{fort.3} file.

% ================================================================================================================================ %
\section{Multipole Coefficients} \label{MulCoe}

Sets of normal and skew multipoles of up to tenth order, each with an RMS value, can be combined with this block.
The multipole kick is calculated using a Horner scheme, which saves considerably in computation time.
Moreover, using the multipole block reduces the number of elements in the single element list (\ref{SinEle}).

\bigskip
\begin{tabular}{@{}lp{0.8\linewidth}}
    \textbf{Keyword}    & \texttt{MULT} \\
    \textbf{Data lines} & 2 to 12 \\
    \textbf{Format}     & First line: \texttt{name $R_{0}$ $\delta_{0}$} \\
                        & Lines 2 to 12: \texttt{$B_{n}$ RMS-$B_{n}$ $A_{n}$ RMS-$A_{n}$}
\end{tabular}

\paragraph{Format Description}~

\bigskip
\begin{tabular}{@{}lp{0.8\linewidth}}
    \texttt{name}    & Name of the multipole block which must appear in the list of single elements (\ref{MulBlo}). \\
    \texttt{$R_{0}$} & Reference radius (in mm) at which the magnet errors are calculated. This makes it convenient to use values from field measurements. \\
    \texttt{$\delta_{0}$} & Bending strength of the dipole (in mrad). Field errors of line 2--11 are taken to be relative to the bending strength.
\end{tabular}

\paragraph{Remarks:}
\begin{enumerate}
    \item The $B_{n}$ and $A_{n}$ are related to the $b_{n}, a_{n}$ of the single nonlinear element (\ref{NonEle}) in the following way:
        \begin{align*}
            b_{n} &= \delta_{0} B_{n} R_{0}^{1-n} 10^{3n-6} \\
            a_{n} &= \delta_{0} A_{n} R_{0}^{1-n} 10^{3n-6}
        \end{align*}
    \item The sign convention and the factorial ($n$!) are treated as for the single non-linear elements in (\ref{NonEle}).
    \item Multipoles of different names can be set to be equal using the \texttt{ORG} input block.
    \item 22--poles are included ($n=11$). By enlarging the parameter \texttt{MMUL} (Appendix~\ref{DSP}) up to 40--poles (\texttt{MMUL=20}) can be treated. To make the change of \texttt{MMUL} effective, it is of course necessary to recompile the program.
\end{enumerate}

% ================================================================================================================================ %
\section{Aperture Limitations} \label{ApeLim}

This input data block is used to introduce additional collimators or aperture limitations in the machine.
Each non-linear element can be used for this purpose.
Rectangular or elliptical shapes of the aperture limitations are allowed.
On top of that, there is a general (rectangular) aperture check at each non-zero length element.
The general aperture values are chosen to be large enough (\ref{T-DTP}) to define the short term dynamic aperture.

\bigskip
\begin{tabular}{@{}lp{0.8\linewidth}}
    \textbf{Keyword}    & \texttt{LIMI} \\
    \textbf{Data lines} & variable \\
    \textbf{Format}     & \texttt{name type xaper yaper}
\end{tabular}

\paragraph{Format Description}~

\bigskip
\begin{tabular}{@{}lp{0.8\linewidth}}
    \texttt{name}   & The name of any non-linear (zero length) element in the \textit{Single Element} input block (\ref{NonEle}) except multipole blocks (\ref{MulBlo}). \\
    \texttt{type}   & Two types of aperture limitations are allowed: \\
                    & \texttt{RE} for a rectangular aperture shape, i.e.
                      \begin{equation*}
                          x_{i} < \mathrm{xaper},\; y_{i} < \mathrm{yaper}
                      \end{equation*}\\
                    & \texttt{EL} for an elliptical aperture shape, i.e.
                      \begin{equation*}
                          \frac{x_{i}^{2}}{\mathrm{xaper}^{2}} + \frac{y_{i}^{2}} {\mathrm{yaper}^{2}} < 1
                      \end{equation*}\\
    \texttt{xaper}  & Aperture in the horizontal plane in mm \\
    \texttt{yaper}  & Aperture in the vertical plane in mm
\end{tabular}

% ================================================================================================================================ %
\section{Power Supply Ripple} \label{PowRip}

{\color{notered}\textbf{Note:}
The \texttt{RIPP} block is been deprecated since release 4.5.20, and the functionality is now provided by the \texttt{DYNK} block (\ref{sec:DYNK}).
A \texttt{fort.3} file containing a \texttt{RIPP} block is therefore no longer valid, and will result in an error message.
The description below is therefore only provided as a reference for those who need to convert old input files.}

\bigskip
\noindent If power supply ripple is to be considered this input data block can be used. A non-linear quadrupole is expected as a ripple element (type=2 and zero length in the single element list (\ref{NonEle})), but in principle other non-linear elements are also allowed.
Ripple depth, ripple frequency and starting phase of the ripple frequency are the input parameters.

\bigskip
\begin{tabular}{@{}lp{0.8\linewidth}}
    \textbf{Keyword}    & \texttt{RIPP} \\
    \textbf{Data lines} & Variable \\
    \textbf{Format}     & \texttt{name depth frequency start-phase nrturn}
\end{tabular}

\paragraph{Format Description}~

\bigskip
\begin{tabular}{@{}lp{0.75\linewidth}}
    \texttt{name}        & Name of the nonlinear element in the \textit{single element} block (\ref{NonEle}) \\
    \texttt{depth}       & Maximum kick strength of the ripple element. A quadrupole kick is usually expected. \\
    \texttt{frequency}   & Given in number of turns (a real value is allowed) of one ripple period. \\
    \texttt{start-phase} & Initial phase of the ripple element. \\
    \texttt{nrturn}      & Initial number of turns, for prolongation runs the  number of turn already done
\end{tabular}

% ================================================================================================================================ %
\section{Dynamic Kicks} \label{sec:DYNK}

\paragraph{Description}
The DYNamic Kicks module~\cite{DYNKpaper} allows time-dependent modification of the settings of single elements.
The supported elements and attributes are listed in Table~\ref{tab:DYNK_SET}.
The settings can be computed on-the fly using several functions, loaded from input files or a combination, as described in Table~\ref{tab:DYNK_FUN}.

Further, unless explicitly switched off using a NOFILE statement, DYNK produces an output file ``dynksets.dat''.
This file contains the setting of all elements and attributes for which DYNK is active.
It is written in all turns of the simulation, even if DYNK is not active in that exact turn.

\paragraph{Keyword} DYNK

\paragraph{Number of data lines} variable

\paragraph{Format}
There are four types of statements possible in a DYNK block, listed below.
On top of this, lines starting with ``/'' are treated as a comment and ignored.

\subparagraph{FUN} \emph{FUN function-name function-type arg1 arg2 arg3 \ldots}\\
This statement defines a function, i.e. something which when evaluated produces a numerical value which can be used to set the value of an element attribute.
The functions in DYNK all have a unique name, and they may take up to 7 arguments (a limitation imposed by the internal parameter \emph{getfields\_n\_max\_fields}).
The function type must be one of those listed in Table~\ref{tab:DYNK_FUN}.
A function may be defined so that it uses the result of another function, which must be defined above it in the DYNK block.
This requirement avoids any possibility for infinite recursion.
The functions are only evaluated when needed, i.e. when used by a SET statement in that turn.
The functions may thus be evaluated multiple times in one turn (if used by multiple SET statements which are active in that turn, or referenced by multiple other FUN statements which are themselves used more than once in that turn), or it may not be evaluated at all.
%All functions types have an index, which is used internally in place of the function type name.
The functions are always evaluated as a function of the current turn number $t$, which may be shifted by a turn-shift specified in a SET statement.
Function names have a maximum length of 20 characters.

\pagebreak
%\begin{table}
\begin{center}
\begin{longtable}{|p{2.25cm} | p{4cm} p{9.5cm}|}
  %Note: \\* (with the star) used to inhibit page breaks in the middle of groups of the same type
  \caption{Available function types in DYNK.}
  \label{tab:DYNK_FUN} \\*
  \hline
  \rowcolor{blue!30}
  Type name & Arguments & Description \\*
  \hline
  \endfirsthead

  \hline
  \rowcolor{blue!30}
  Type name & Arguments & Description \\*
  %\hline
  \endhead

  \rowcolor{gray!15}
  \multicolumn{3}{|c|}{(The table continues on the next page)}\\*
  \hline
  \endfoot
  
  \hline
  \endlastfoot

  %\hline
  \rowcolor{blue!15}
  ``System'' functions & & \\*

  GET        & \emph{element-name[string] attribute-name[string]} & 
  Extracts the original value of a setting, i.e. as specified in the SINGLE ELEMENT section (Sec.~\ref{SinEle}). Attributes as used for SET, see Table~\ref{tab:DYNK_SET}. \\*

  FILE       & \emph{filename[string]} &
  Loads the settings from file; the file is expected to be an ascii file with two columns where the first column is the turn number (should start at 1 and include all turns up to as long as is wanted), and the second column is the value for that turn number.\\*
  
  FILELIN    & \emph{filename[string]} &
  Similar to FILE, but any double can be used as the turn number as long as they are monotonically rising.
  When evaluated, the function interpolates from the line-segments specified in the file. \\*
  
  PIPE       & \emph{inPipeName[string] outPipeName[string] ID[string] fileUnit[int]} &
  Uses a pair of UNIX FIFOs, through which it can communicate with an external program.
  When evaluated, it sends a message through the outpipe, and then waits for a message on the inpipe which should contain the value the FUN should returned.
  The ID is used in case several DYNK PIPE FUNs are using the same outPipe and inPipe, so that the controlling external program can choose what to calculate.
  Note that it will use both \texttt{fileUnit} and \texttt{fileUnit+1}, and if several PIPE FUNs are using the same file, they must also use the same \texttt{fileUnit}.
  For more details, see the example below.
  Also note that PIPE is not available in the checkpoint/restart version of SixTrack.\\*
  
  RANDG      & \emph{seed1[int] seed2[int] mu[real] sigma[real] mcut[int]} &
  Returns a pseudorandom number generated from a Gaussian distribution.
  The mean value and width is controlled by \emph{mu} and \emph{sigma}, while \emph{mcut} is the maximum number of sigmas to generate numbers up to; set to 0 to disable this cut.
  The integers \emph{seed1} and \emph{seed2} are the seed used to initialize the RANECU generator.
  Note that every RANDG function defined in DYNK uses its own separate random number stream.\\

  RANDU      & \emph{seed1[int] seed2[int]} &
  Returns a pseudorandom number generated from a uniform distribution.
  The integers \emph{seed1} and \emph{seed2} are the seed used to initialize the RANECU generator.
  Note that every RANDU function defined in DYNK uses its own separate random number stream.\\
  
  RANDON      & \emph{seed1[int] seed2[int] P[float]} &
  Returns the value of 1.0 or 0.0 resulting of the weighting with the probability \emph{P} of a pseudorandom number generated from a uniform distribution .
  The integers \emph{seed1} and \emph{seed2} are the seed used to initialize the RANECU generator.
  Note that every RANDON function defined in DYNK uses its own separate random number stream.\\

  \hline
  \rowcolor{blue!15}
  Filters & & \\*
  
  FIR        & \emph{N[int] filename[string] baseFun[string]} &
  Applies a Finite Impulse Response (FIR) filter of order \emph{N} to the function \emph{baseFun}.
  The output is given as $y[t] = \sum_{i=0}^N b_i*x[t-i]$, where $t$ is the current turn and $x[t-0]$ is the result of the most recent call to \emph{baseFun}.
  The coefficients $b_0 \ldots b_N$ and initial values of $x[t-0]\ldots x[t-N]$ are loaded from the given file \emph{filename}, which is a space-separated ascii file with three columns.
  These columns are (1) row index \emph{[int]}, (2) coefficients $b_i$ \emph{[float]} and (3) initial values of the $x[]$ array \emph{[float]}.
  The row indices are expected to go from $0$ to at least $N$ in steps of $1$.
  Note that the filter is stepped once per call, i.e. the array $x[]$ is shifted once every time the FUN is called.
  Also note that when called, the filter is first stepped, then the new value is filled into the first position in $x[]$, and finally the sum is evaluated.
  This means that the last value in the $x[]$ array is never used, while the first value ($x[t-0]$) is immediately pushed into $x[t-1]$ before the first evaluation.\\*
  
  IIR        & \emph{N[int] filename[string] baseFun[string]} &
  Applies an Infinite Impulse Response (IIR) filter of order \emph{N} to the function \emph{baseFun}.
  This is very similar to FIR, except that it also uses its own previous outputs.
  The sum is thus written as $y[t] = \sum_{i=0}^N b_i*x[t-i] + \sum_{i=1}^N a_i*y[t-i]$.
  The file \emph{filename} is identical to that which is used for FIR, except for adding two more columns.
  These columns are (4) $a_0\ldots a_N$ \emph{[float]} and (5) initial values for the $y[]$ array \emph{[float]}.
  Note that $a_0$ is never used, and the value of $y[t-0]$ is pushed back to $y[t-1]$ before the first evaluation of the sum, such that $y[t-N]$ is never used.\\

  \hline
  \rowcolor{blue!15}
  2-operand operators & & \\*

  ADD        & \emph{function-name-1[string] function-name-2[string]} &
  Evaluate the functions referenced by \emph{function-name-1} and \emph{function-name-2}, and return the sum of the results.\\*

  SUB        & \emph{function-name-1[string] function-name-2[string]} &
  Similar to ADD, but return the result of function1 minus function2.\\*
  
  MUL        & \emph{function-name-1[string] function-name-2[string]} & 
  Similar to ADD, but return the product of the results. \\*

  DIV        & \emph{function-name-1[string] function-name-2[string]} & 
  Similar to ADD, but return the result of function1 divided by function2\\*
  
  POW        & \emph{function-name-1[string] function-name-2[string]} & 
  Similar to ADD, but return the result of function1 raised to the power of function2.\\
  
  \hline
  \rowcolor{blue!15}
  1-operand operators & & \\*

  MINUS      & \emph{function-name} &
  Returns the value of the named function, with the oposite sign. \\*

  SQRT       & \emph{function-name} & 
  Returns the square root of the value generated by the named function. \\*
  
  SIN        & \emph{function-name} & 
  Returns the sine of the value generated by the named function. \\*
  
  COS        & \emph{function-name} &
  Returns the cosine of the value generated by the named function. \\*
  
  LOG        & \emph{function-name} &
  Returns the natural logarithm of the value generated by the named function. \\*
  
  LOG10      & \emph{function-name} &
  Returns the common logarithm of the value generated by the named function. \\*
  
  EXP        & \emph{function-name} &
  Returns the natural exponential function $e^x$, where $x$ is the value generated by the named function. \\
  
  \hline
  \rowcolor{blue!15}
  Polynomial and elliptical functions &  & \\*

  CONST       & \emph{value[real]} & 
  Always returns the value specified.\\*

  TURN        & (none) & 
  Return the turn number, i.e. $y(t) = t$.\\*

  LIN         & \emph{a[real] b[real]} & 
  Computed value from the linear function $y(t) = a\cdot t + b$. \\*

  LINSEG      & \emph{x1[real] x2[real] y1[real] y2[real]} & 
  The function is defined by a line segment between the points $(x_1,y_1)$ and $(x_2,y_2)$, and undefined for $x < x_1$ and $x>x_2$. 
  It is required that $x_1 < x_2$.\\*

  QUAD        & \emph{a[real] b[real] c[real]} & 
  Computed value from the quadratic function $y(t) = a\cdot t^2 + b\cdot t + c$. \\*

  QUADSEG     & \emph{x1[real] x2[real] y1[real] y2[real] deriv1[real]} & 
  The quadratic function is defined by overlapping the quadratic curve segment which passes through the points $(x_1,y_1)$ and $(x_2,y_2)$, and $\mathrm{d}y/\mathrm{d}x$ at $x_1$ is \emph{deriv1}. 
  The quadratic coefficients $a,b,c$ are calculated as $a = \frac{\emph{deriv1}}{x_1-x_2} + \frac{y_2-y_1}{(x_1-x_2)^2}$, $b=\frac{y_2-y_1}{x_2-x_1} - (x_1+x_2)\cdot a$ and $c = y_1 + \left(- x_1^2 \cdot a - x_1 \cdot b \right)$.\\

  \hline
  \rowcolor{blue!15}
  Trancendental functions & & \\*

  SINF        & \emph{A[real] omega[real] phi[real]} & 
  Computes $y(t) = A\sin\left(\omega t + \phi\right)$.\\*

  COSF        & \emph{A[real] omega[real] phi[real]} & 
  Computes $y(t) = A\cos\left(\omega t + \phi\right)$.\\*
  COSF\_RIPP  & \emph{A[real] period[real] phi[real]} & 
  Computes $y(t) = A\cos\left(\frac{2\pi (t-1)}{\mathrm{period}} + \phi\right)$. 
  This specialized cosine is provided for compatibility, to be used when replacing old \emph{RIPP} blocks.\\*

  \hline
  \rowcolor{blue!15}
  Specialized functions & & \\*

  PELP        & \emph{tinj[real] Iinj[real] Inom[real] A[real] D[real] R[real] te[real]} & 
  This function describes a patched ``Parabolic-Exponential-Linear-Parabolic'' function, as used for ramping the LHC dipoles and described in~\cite[Appendix C]{SRussen:fieldComp} and~\cite{BurlaKing:CurrentRamp}. 
  The parameters are:
  \begin{itemize}
  \setlength\itemsep{-0.3em}
  \item The injection time \emph{tinj}, which is the time (in turn numbers) when the ramp starts.
  \item The injection value \emph{Iinj}, which is the value when $t\le t_{inj}$
  \item The final value \emph{Inom}, which is the value after the end of the ramp.
  \item The acceleration parameter \emph{A}, which describes how fast the current is growing in the first (parabolic) segment.
  \item The decelertation parameter \emph{D}, which describes how fast the current growths flattens out in the forth (parabolic) segment.
  \item The ramp rate \emph{R}, which describes the maximum ramp rate, seen in the third (linear) segment.
  \item The start time of the ramp \emph{te}, which describes at what time it switches from the parabolic (first) to the exponential (second) segment.
  \end{itemize}
  \\*
  ONOFF       & \emph{p1[int] p2[int]} &
  This function is a periodic ``pulse width modulation'' with period p2 and pulse length p1.
  It may be described as
  $y(t) =  \left\{1.0 \; \mathrm{if} \; \mathrm{mod}(t-1,p2) < p1 \right\}; \; \left\{ 0.0 \; \mathrm{otherwise} \right\}$.
  The reason for using $t-1$ is that the modulus is naturally zero-based, while SixTrack counts turns starting from 1.
  Note that it is expected that $p1 >= 0$, $p2 > 1$, and $p1 <= p2$.
  Also note that for negative $t$, the function will always return 1.0.
\end{longtable}
\end{center}
%\end{tabular}
%\end{table}


\subparagraph{SET} \emph{SET element-name attribute-name function-name first-turn last-turn turn-shift}\\
This statement defines an element setpoint, which changes an element/attribute to the value computed by the given function.
The \emph{SET} becomes active when the turn number reaches \emph{first-turn}, and switches off once \emph{last-turn} has been passed.
When switched off, the value applied in \texttt{last-turn} stays for the rest of the simulation, or until overwritten by another \emph{SET}.
If \emph{last-turn} equals -1, the \emph{SET} is active untill the end of the simulation.
The element type and attribute combinations which can be used in DYNK is shown in Table~\ref{tab:DYNK_SET}.

The argument \emph{turn-shift} is an integer (positive, negative, or zero) number which is added to the current turn number before computing the function.
Thus, in order to (as an example) apply an exponential decay from the value $v_0$ starting in turn $t_0$ using the function defined as $f(t) = V_0 \exp(-t/\tau)$,
a \emph{turn-shift} $-t_0$ should be applied.

In addition to changing single element attributes, it is also possible to use DYNK to change certain global attributes such as the reference energy.
This is done through the ``element'' \texttt{GLOBAL VARS}; for example one may want to simulate an energy ramp following the function \texttt{eramp} throughout the whole simulation.
For this, one would use the \emph{SET} command ``\texttt{SET GLOBAL-VARS E0 eramp 1 -1 0}''.
Because of this, SixTrack does not accept a real single element in \texttt{fort.2} named \texttt{GLOBAL-VARS} if \texttt{DYNK} is active.

\begin{table}[h]
\begin{center}
%\begin{longtable}{|p{2.25cm} | p{4cm} p{9.5cm}|}
%\begin{longtable}{|l | l l l|}
  %Note: \\* (with the star) used to inhibit page breaks in the middle of groups of the same type
\caption{Element types and attributes available in DYNK.}
\label{tab:DYNK_SET} %\\*
\begin{tabular}{|l | l l p{6cm}|}

  \hline
  \rowcolor{blue!30}
  Element type (idx) & Attribute & Units & Description \\
  \hline
  % \endfirsthead

  % \hline
  % \rowcolor{blue!30}
  % Element type (idx) & Attribute & Units & Description \\*
  % %\hline
  % \endhead

  % \rowcolor{gray!15}
  % \multicolumn{3}{|c|}{(The table continues on the next page)}\\*
  % \hline
  % \endfoot
  
  % \hline
  % \endlastfoot

  %\hline
  \parbox{4cm}{~\\[-1mm] Standard thin elements\\ ($\pm$1 -- $\pm$10),\\ Section~\ref{NonEle}\\[-3mm]}
    & \texttt{average\_ms} & radians * m\textsuperscript{-n} & See Table~\ref{T-NonEle} \\
  \hline
  \multirow{3}{*}{\parbox{4cm}{RF cavities ($\pm$12),\\ Section~\ref{Cavities}}}
    & \texttt{voltage}     & MV      & One-turn accelerating voltage \\
    & \texttt{harmonic}    & --      & Harmonic number of the cavity \\
    & \texttt{lag\_angle}  & degrees & Lag angle of the cavity \\
  \hline
  \multirow{3}{*}{\parbox{4cm}{RF multipoles\\ ($\pm$23, $\pm$26 -- $\pm$28),\\ Section~\ref{CrabCav}}}
    & \texttt{voltage}     & MV      & Kick voltage \\
    & \texttt{frequency}   & MHz     & Frequency \\
    & \texttt{phase}       & radians & Offset between zero-crossing and ideal bunch center \\
  \hline
    \multirow{3}{*}{\parbox{4cm}{Electron lens \\ (29),\\ Section~\ref{sec:elen}}}
    & \texttt{thetamax}     & mrad      & Maximum angular kick \\
    &      &       &  \\
    &      &       &  \\
  \hline
    \multirow{3}{*}{\parbox{4cm}{Scattering \\ (40),\\ Section~\ref{sec:scatter}} }
    & \texttt{scaling}     & --      & Scaling of probability, see Section~\ref{sec:scatter}, paragraph about ELEM command.\\
    &      &       &  \\
    &      &       &  \\
  \hline
    \multirow{3}{*}{\parbox{4cm}{\texttt{GLOBAL-VARS} \\ Not a real element,\\ changes global variable}}
    & \texttt{E0}     & MeV      & Reference energy of synchronous particle \\
    &      &       &  \\
    % &      &       &  \\
  \hline

%\end{longtable}
\end{tabular}
\end{center}
\end{table}

\subparagraph{NOFILE}
The presence of this statement in a DYNK block switches off the normal writing of the output file ``dynksets.dat'' in every line, instead producing a file only containing the message ``\#\#\# DYNK file output was disabled with flag NOFILE in fort.3 \#\#\#''.
This can be useful to save disk space in very long simulations.

\subparagraph{DEBU}
This statement switches on extra ``debugging'' output from DYNK.
This can be useful if debugging the code or if debugging the input.

\paragraph{Output file \emph{dynksets.dat}}
When a DYNK block is present in the input file, a file ``dynksets.dat'' is created and in the current working directory.
Unless a \emph{NOFILE} statement is present, this file contains first a header ``\# turn element attribute SETidx funname value'', followed by rows of data in the format specified in the header.
This data is written for all element/attribute combinations and in all turns, wether a SET is active for this element/attribute in this turn or not.
If no \emph{SET} is active when the line is written out, the \emph{SETidx} is written as -1, and the \emph{funname} is ``N/A''.
If a SET is active when the line is written out, the \emph{SETidx} is the index of the currently active \emph{SET} statement, where the first statement occuring in fort.3 has index 1 etc.
Similarly, the \emph{funname} is the name referencing the currently active \emph{FUN} statement.

\paragraph{Examples}

\subparagraph{Replacement of RIPP block}
One use of the DYNK block is to replace the functionality of the RIPP block (Section~\ref{PowRip}).
The FUN type COSF\_RIPP is provided for exactly this purpose, and provides an exact replacement.
As an example, the RIPP block in the SixTest test-case prob1 looks like (slightly reduced in size):
\begin{verbatim}
RIPPLE OF POWER SUPPLIES------------------------------------------------
         dmqx1f50l5+2      3.2315D-10    224.9
         dmqx2af50l5+2    -3.2315D-10    224.9
         dmqx1f10mel5+2    2.5246D-16    0.0011245
NEXT
\end{verbatim}
This can be replaced by the following:
\begin{verbatim}
DYNK
NOFILE
FUN RIPP-dmqx1f50l5+2 COSF_RIPP 3.2315D-10 224.9 0.0
SET dmqx1f50l5+2 average_ms RIPP-dmqx1f50l5+2 1 -1 0
FUN RIPP-dmqx2af50l5+2 COSF_RIPP -3.2315D-10 224.9 0.0
SET dmqx2af50l5+2 average_ms RIPP-dmqx2af50l5+2 1 -1 0
FUN RIPP-dmqx1f20kl5+2 COSF_RIPP 2.5246D-12 0.56225 0.0
SET dmqx1f20kl5+2 average_ms RIPP-dmqx1f20kl5+2 1 -1 0
NEXT
\end{verbatim}
Here, each RIPP data line is replaced with two lines, one FUN statement for generating the function, and one SET statement for applying the value.
Note that the SET statements have an end-time ``-1'', meaning it is used untill the end of the simulation.
Also note the precense of the NOFILE flag, which is used to not generate a potentially very large (for very long simulations) dynkfile.dat output file.

\subparagraph{Starting tracking inside a bump}

This example was taken from the paper~\cite{DYNKpaper}, and demonstrates how a bump can be temporarilly disabled if the starting point of the tracking is inside of it.
The reason for doing this is removing the neccessity of generating a starting distribution with the bump already applied.
Here, the HL-LHC v1.1 lattice is used, with vertical crab cavities around the first interaction point (IP1, ATLAS), which is also the point where the tracking is started.
The crab cavities opening the bump are called CRAB\_IP1\_L1$\cdots$4, while the closing cavities are CRAB\_IP1\_R1$\cdots$4.
The DYNK block for this looks like:
\begin{verbatim}
DYNK
FUN zero CONST 0.0
FUN CV_1R1 Get CRAB_IP1_R1 voltage
FUN CV_1R2 GET CRAB_IP1_R2 voltage
FUN CV_1R3 GET CRAB_IP1_R3 voltage
FUN CV_1R4 GET CRAB_IP1_R4 voltage
SET CRAB_IP1_R1 voltage zero 1 1 0
SET CRAB_IP1_R2 voltage zero 1 1 0
SET CRAB_IP1_R3 voltage zero 1 1 0
SET CRAB_IP1_R4 voltage zero 1 1 0
SET CRAB_IP1_R1 voltage CV_1R1 2 2 0
SET CRAB_IP1_R2 voltage CV_1R2 2 2 0
SET CRAB_IP1_R3 voltage CV_1R3 2 2 0
SET CRAB_IP1_R4 voltage CV_1R4 2 2 0
NEXT
\end{verbatim}

Here, the function ``zero'' is defined such that it always returns 0.0, and is used to switch off the closing cavities in the first turn, i.e. when the beam exits the bump.
Further, the functions CV\_1R1$\cdots$1R4 and CV\_1L are used to store the original value of the voltages, without having to explicitly enter them into the DYNK block.

The SET statements then first sets the voltage of all the cavities to zero in turn 1, and then in turn 2 sets it to their respective ``switched on'' voltages.
The SET statements end after turn 2, but the last values are retained.

This means that when the simulation starts with the bunch in IP1, it exits the bump without any kicks from the closing crab cavities.
It then comes around (still in turn 1), and encountered the switched-on opening cavities CRAB\_IP1\_L1$\cdots$4, which crabs the beam.
After passing through IP1, the turn counter is increased from 1 to 2, triggering the SET statements to switch on the closing cavities CRAB\_IP1\_R1$\cdots$4 as well.

\subparagraph{Ramp and exponential decay of crab voltage, combined with a linear drift of crab phase}
\begin{figure}
  \centering
  \includegraphics{figures/fail_voltagePhase2v2}
  \caption{Singals generate by DYNK example for ramp + exponential decay of crab voltage, and also linear drift of crab phase. Only the signals for CRAB\_IP1\_L1 are shown. The plot is made from the data in dynksets.dat.}
  \label{fig:DYNK_fail}
\end{figure}

This slightly more complicated example builds on the example given above.
It shows how to change two parameters (voltage and phase) of several objects.
It also demonstrates how functions can be chained together, making more complicated functions.
Some of the resulting functions are shown in Figure~\ref{fig:DYNK_fail}, and the DYNK block here looks like:
\begin{verbatim}
DYNK
/DEBUG
FUN zero CONST 0.0
FUN CV_R1 GET CRAB_IP1_R1 voltage
FUN CV_R2 GET CRAB_IP1_R2 voltage
FUN CV_R3 GET CRAB_IP1_R3 voltage
FUN CV_R4 GET CRAB_IP1_R4 voltage
FUN CV_L  GET CRAB_IP1_L1 voltage
FUN ramp LIN 0.02 0
FUN ramp_R1 MUL CV_R1 ramp
FUN ramp_R2 MUL CV_R2 ramp
FUN ramp_R3 MUL CV_R3 ramp
FUN ramp_R4 MUL CV_R4 ramp
FUN ramp_L  MUL CV_L  ramp
SET CRAB_IP1_R1 voltage zero 1 10 0
SET CRAB_IP1_R2 voltage zero 1 10 0
SET CRAB_IP1_R3 voltage zero 1 10 0
SET CRAB_IP1_R4 voltage zero 1 10 0
SET CRAB_IP1_L1 voltage zero 1 9 0
SET CRAB_IP1_L2 voltage zero 1 9 0
SET CRAB_IP1_L3 voltage zero 1 9 0
SET CRAB_IP1_L4 voltage zero 1 9 0
/
SET CRAB_IP1_R1 voltage ramp_R1 11 61 -11
SET CRAB_IP1_R2 voltage ramp_R2 11 61 -11
SET CRAB_IP1_R3 voltage ramp_R3 11 61 -11
SET CRAB_IP1_R4 voltage ramp_R4 11 61 -11
SET CRAB_IP1_L1 voltage ramp_L 10 60 -10
SET CRAB_IP1_L2 voltage ramp_L 10 60 -10
SET CRAB_IP1_L3 voltage ramp_L 10 60 -10
SET CRAB_IP1_L4 voltage ramp_L 10 60 -10
/
/Voltage decay and detuning
FUN expCore LIN -0.05 0.0
FUN decay EXP expCore
FUN decayScaled MUL decay CV_L
SET CRAB_IP1_L1 voltage decayScaled 70 100 -70
SET CRAB_IP1_L2 voltage decayScaled 70 100 -70
SET CRAB_IP1_L3 voltage decayScaled 70 100 -70
SET CRAB_IP1_L4 voltage decayScaled 70 100 -70
FUN phasedrift LIN 0.3141592654 0.0
SET CRAB_IP1_L1 phase phasedrift 70 100 -70
SET CRAB_IP1_L2 phase phasedrift 70 100 -70
SET CRAB_IP1_L3 phase phasedrift 70 100 -70
SET CRAB_IP1_L4 phase phasedrift 70 100 -70
NEXT
\end{verbatim}
The first functions defined here are the same as above, storing the default values (as defined in the single element list) for the relevant elements and also zero.
Then follows a normalized linear ramp function ``ramp'', with gradient 0.02 = 1/50.
This is then used by the ``specialized'' ramp functions ``ramp\_R1$\cdots$R4'', which scales ``ramp'' so that the end point is the standard voltages for $t\in 0\ldots50$.

These functions are used to first set the crabs to 0.0 for the first 9 revolutions, and in the 10th revolution the ramp starts.
As the ``ramp'' function is defined starting at turn 0, a shift -10 or -11 is applied to the ramps.
The ramp is switched off after turn 60/61, leaving the crabs to be operating at the last SET value.

Further, we want to demonstrate a failure in the crab voltage.
This is done using an exponential decaying function $V(t) = V_0 \exp\left(-0.05 t\right)$, which is implemented as three chained functions:
\begin{description_alligned}{decayScaled}
\item[expCore] $f(t) = -0.05 t + 0.0$
\item[decay] $g(t) = \exp(f(t)) = \exp(-0.05 t + 0.0)$
\item[decayScaled] $h(t) = V_0 \cdot g(f(t)) = V_0 \cdot \exp(f(t)) = \exp(-0.05 t + 0.0)$
\end{description_alligned}
For the SET, the time $t$ is then shifted by -70 turns, so that the functions are evaluated starting at t=0.

\subparagraph{Detuning a cavity (accelerating or crab)}~\\
\todo[inline]{Write}

\subparagraph{Using the PIPE function}~\\
%Note: This example is referenced from the FUN table.

To use the PIPE functionality, add a FUN and SET to the DYNK block such as:
\begin{verbatim}
FUN pipe1 PIPE /tmp/pip1 /tmp/pip2 myID1 4242
SET  ACFCA.AR1.B1 voltage pipe1 10 -1 -9
\end{verbatim}
Then create the two pipes using the \texttt{mkfifo} UNIX command, e.g.\ \texttt{mkfifo~pip1} and \texttt{mkfifo~pip2} in the chosen directory.
When starting SixTrack, it will first open the input pipe (while reading the DYNK block), and wait for the external program to do the same.
This can be simulated by running \texttt{cat~>~pip1}; it is also possible to open the input pipe before starting SixTrack.
After opening the input pipe, SixTrack will open the output pipe, again this can be simulated by running \texttt{cat~pip2}, and again this pipe may be opened before starting SixTrack.
Note that when SixTrack ends, the output pipe will be closed, so the recieving \texttt{cat} process is terminated.

After opening the output pipe, SixTrack writes the line \texttt{DYNKPIPE~!******************!} to this file.
It then writes a line similar to \texttt{INIT~ID=myID1~for~FUN=pipe1} for each FUN using this output pipe.

During tracking, when one of the PIPE FUNs are called SixTrack writes a line similar to \texttt{GET ID=myID1 TURN=~1} to the output pipe.
Note that the turn number is the one passed to the FUN from SET, i.e. including any turn-shift.
It then waits for a single floating point number to be written (in ascii) to the input pipe, which is then read and returned from the FUN.

\section{Beam--Beam Element}
\label{BeamBeam}

\paragraph{Description} The beam--beam kick, including a separation of the beams, is treated \`{a} la Basetti and Erskine~\cite{BasErs} and implemented as in MAD~\cite{MAD}.
However, a much faster but nevertheless precise calculation using interpolation can be used~\cite{ERIC}.
For SixTrack version 3 the beam--beam is also available in the 6D form \`{a} la Hirata~\cite{Hirata}.
Lastly, the linear coupling has been considered in 4 and 6 dimensional phase space~\cite{ripbeam}. 

\paragraph{Keyword} BEAM
\paragraph{Number of data lines} variable but at least one

\paragraph{Format}
Two different input formats are available, ``traditional'' and ``EXPERT''.
If ``EXPERT'' mode is wanted, this is triggered by adding the flag \texttt{EXPERT} on the first line of the block.

\subparagraph{Traditional format}

\begin{itemize}
\item first data line: {\em partnum emitnx emitny sigz sige ibeco
    ibtyp lhc ibbc} 
\item other data lines: {\em name ibsix xang xplane xstr}
\end{itemize}

\begin{description}
\item [partnum] (float) Number of particles in bunch
\item [emitnx,emitny] (floats) Horizontal and vertical normalized
  emittance respectively [$\mu m\cdot rad$]
\item [sigz,sige] (floats) R.m.s. bunch length [m] and r.m.s. energy
  spread
\item [ibeco] (integer) Switch (0 = off; 1 = on) to subtract the
  closed orbit introduced by the separation of the beams. It is
  recommended to always subtract it as it is not yet calculated in a
  selfconsistent manner. The \emph{ibeco} switch also acts on the ``wire'' elements \ref{sec:WIRE} in the same way as on the beam-beam elements. It subtracts the closed orbit introduced by the wire if \emph{ibeco}=1 and applies it if \emph{ibeco}=0.
\item [ibtyp] (integer) Switch (0 = off; 1 = on) to use the fast
  beam--beam algorithms developed in collaboration with G.A.~Erskine
  and E.~McIntosh.  The linear optics are calculated with ``exact''
  beam--beam kicks.
\item [lhc] For the LHC with its anti--symmetric IR the separation of
  the beams in one plane can be calculated by the $\beta$--function of
  the other plane. For flat beams (not anti-symmetric optics) the separation
  can be loaded from the fort.2 file. (0 = off; 1 = anti-symmetric; 2 = load from file).
\item [ibbc] Linear coupling considered in 4D and 6D (0 = off; 1 = on).
\item [name] Name of 6D beam--beam element. Beam--beam elements that
  do not appear will be treated as 4D kicks.
\item [ibsix] (integer) Number of slices of the 6D beam--beam element.
  If {\it ibsix} is set to 0 this element is treated as a 4D element.
\item [xang] (float) Half crossing angle (angle the between the trajectories of the two beams) at this particular element [rad].
\item [xplane] (float) Crossing plane angle [rad].
\item [xstr] (float) Angle of the position of the slices in the boosted frame [rad] (i.e. $X = Z \sin(\mathit{xstr}) \cos(\mathit{xplane})$, $Y =Z \sin(\mathit{xstr}) \cos(\mathit{xplane})$ ).
  In absence of crabbing user should make sure \textit{xstr=xang}; in case the \textit{xstr} flag is not set then \textit{xstr=xang} is assumed and a warning is printed (since version 4.5.45).
\end{description}

\subparagraph{EXPERT format}

\begin{itemize}
\item first data line: {\em EXPERT}
\item second data line: {\em partnum emitnx emitny sigz sige ibeco
    ibtyp lhc ibbc} 
\item other data lines -- 4D BB lens (1 line per element): \\
{\em name ibsix $\Sigma_{x,x}$ $\Sigma_{y,y}$ h-sep v-sep strength-ratio}
\item other data lines -- 6D BB lens (3 lines per element): \\
{\em name ibsix xang xplane h-sep v-sep} \\
{\em $\Sigma_{x,x}$ $\Sigma_{x,xp}$ $\Sigma_{xp,xp}$ $\Sigma_{y,y}$ $\Sigma_{y,yp}$} \\
{\em $\Sigma_{yp,yp}$ $\Sigma_{x,y}$ $\Sigma_{x,py}$ $\Sigma_{xp,y}$ $\Sigma_{xp,yp}$ strength-ratio} \\
\end{itemize}

Some parameters are new or defined in a different way:
\begin{description}
\item [lhc] This parameter is kept for now only for RHIC studies when equal to 9.
\item [name] Name of the beam--beam element.
\item [ibsix] (integer) Number of slices of the 6D beam--beam element.\\
  If {\it ibsix} is set to 0 this element is treated as a 4D element.\\
  If {\it ibsix} is larger or equal 1 this element is treated as a 6D element.
\item [$\Sigma_{xx}$] Horizontal $\sigma$ for the strong beam $\rm{[mm^2]}$.
\item [$\Sigma_{yy}$] Vorizontal $\sigma$ for the strong beam $\rm{[mm^2]}$.
\item [h-sep] Horizontal beam--beam separation [mm]
\item [v-sep] Vertical beam--beam separation [mm]
\item [strength-ratio] Strength ratio with respect to the nominal beam--beam kick strength.
  This is useful to allow for splitting one beam--beam kick into several (longitudinally close by) kicks.
\item [$\Sigma_{i,j}$] Second order momenta matrix for the strong beam, in units of mm and mrad.
  For example $\Sigma_{xxp}$ in [mm\ mrad]
\end{description}

\subparagraph{Conversion from traditional to EXPERT format}
An automatic converter from the ``traditional'' input block to the new ``expert'' format is built into SixTrack; every time a non-EXPERT input block is encountered, a conversion is printed to the standard output.
Therefore, all the user needs to do is to run SixTrack (number of turns does not matter) on an input file that should be converted, and follow the instructions which are printed at the beginning of the program output.

\paragraph{Remark} These beam--beam elements have to appear in the single element list (~\ref{NonEle}) (type 20).
If the ``traditional'' option is used in the BEAM block, the listing in the single element list must contain their horizontal and vertical beam--beam separations (see~\ref{BBS}).

\paragraph{Sign Convention} Some clarifications regarding the sign convention used
for the separation and crossing angle variables.
%\todo[inline]{Check if applies to both ``traditional'' and ``EXPERT'' format.}
\begin{itemize}
 \item Separations:
 \begin{enumerate}
  \item The separation is added to the transverse coordinates of each particles just before the beam-beam subroutines (see Fig.~\ref{fig:BB_sep}).
  \begin{eqnarray*}
   \tilde x_i=x_i+sep_x-CO_x \\
   \tilde y_i=y_i+sep_y-CO_y 
  \end{eqnarray*}
  \item Lorentz boost applied to the updated coordinates.
  \item The separation used for the actual beam-beam kick (sep$_{x,y,kick}$) is the difference between the centroid of the strong slice (X$^{\dag}$,Y$^{\dag}$) and the each particle (x$_i$,y$_i$).
  \item Antiboost to return to accelerator frame.
  \item The separation is removed and the closed orbit is added back. Tracking continues.
  \begin{eqnarray*}
   \tilde x_i=x_i-sep_x+CO_x \\
   \tilde y_i=y_i-sep_y+CO_y
   \end{eqnarray*}
 \end{enumerate}
 \begin{figure}[h]
 \begin{center}
 \includegraphics[width=0.8\textwidth]{figures/BB_sep}
 \caption{Coordinate manipulation taking into consideration the beam-beam lens separation as stated in point 1 of the separation sign convention.}
 \label{fig:BB_sep}
 \end{center}
\end{figure}
 \item Crossing angles:
 \begin{enumerate}
  \item The closed orbit is removed just before the beam-beam subroutines.
  \begin{eqnarray*}
   \tilde x'_i=x'_i-CO_{x'} \\
   \tilde y'_i=y'_i-CO_{y'}
  \end{eqnarray*}
  \item Lorentz boost applied to the updated coordinates.
  \item Apply Synchro-Betatron Mapping.
  \item Antiboost to return to accelerator frame.
  \item The closed orbit is added back. Tracking continues.
  \begin{eqnarray*}
   \tilde x'_i=x'_i+CO_{x'} \\
   \tilde y'_i=y'_i+CO_{y'}
  \end{eqnarray*}
 \end{enumerate}
 \begin{figure}[h]
 \begin{center}
 \includegraphics[width=0.8\textwidth]{figures/BB_xsing}
 \caption{Coordinate manipulation to move from the accelerator frame to a head-on collision frame (Figures left and center). A positve crossing angle is considered as shown in the left figure.
 Then Lorentz boost and Synchro-Betatron Mapping are applied (right).}
 \label{fig:BB_xsing}
 \end{center}
\end{figure}
\end{itemize}

\section{Wire} \label{sec:WIRE}

\paragraph{Description} The wire block serves for reading in the input parameters for the wire. Each wire also needs to be added as single element in the list of single elements.

\paragraph{Keyword} WIRE

\paragraph{Number of data lines} variable

\paragraph{Format} \emph{name flag\_co current int\_length phys\_length disp\_x disp\_y tilt\_x tilt\_y}
A description of the input parameters for the wire is given in Table~\ref{tab:wire}.
\begin{center}
	\begin{longtable}{|p{2.0cm} p{1.0cm} p{9.2cm}|}
		%Note: \\* (with the star) used to inhibit page breaks in the middle of groups of the same type
		\caption{Input parameters for WIRE block.}
		\label{tab:wire} \\*
		\hline
		\rowcolor{blue!30}
		Arguments & unit & Description \\*
		\hline
		\endfirsthead
		
		\hline
		\rowcolor{blue!30}
		Arguments & unit & Description \\*
		%\hline
		\endhead
		
		\rowcolor{gray!15}
		\multicolumn{3}{|c|}{(The table continues on the next page)}\\*
		\hline
		\endfoot
		
		\hline
		\endlastfoot
		
		\hline
		
		\emph{name} & - &
		Name of wire. Must be the same as in list of single elements.\\*
		
		\emph{flag\_co} & - &
		flag to define the displacement of the wire in respect to the closed orbit or x=y=0. For \emph{flag\_co}=+1 \emph{disp\_*} is the distance between x=y=0 and the wire. For \emph{flag\_co}=-1 \emph{disp\_*} is the distance between the closed orbit and the wire.\\*
		\emph{current} & A &
		wire current \\*
		\emph{int\_length} & m &
		integrated length of the wire\\*
		\emph{phys\_length} & m &
		physical length of the wire\\*
		\emph{disp\_x} & mm &
		hor. displacement of the wire\\*
		\emph{disp\_y} & mm &
		vert. displacement of the wire\\*
		\emph{tilt\_x} & degrees &
		hor. tilt of the wire $-90 < tilt\_x < 90$ (uses same defintion as DISP block) \\*
		\emph{tilt\_y} & degrees &
		vert. tilt of the wire $-90 < tilt\_y < 90$ (uses same defintion as DISP block) \\*
		\hline		
	\end{longtable}
\end{center}

\paragraph{Remark} The user has to check that the wires defined in the WIRE block are also defined in the list of single elements and vice versa. All parameters except for the type (type 15) are ignored in the single element definition and the execution is aborted if the parameters are non-zero. In addition to the parameters defined in the WIRE block, the \emph{ibeco} parameter in the BEAM block (see Sec.~\ref{BeamBeam}) imposes the same behavior on the wire as for beam-beam. Explicitly, the closed orbit introduced by the wire is subtracted if \emph{ibeco}=1 and not subtracted if \emph{ibeco}=0.

\paragraph{Example} In the following we give some examples for wire definitions. This example defines two wires wire\_1 and wire\_2.

The input block in \verb|fort.3| is given by:
\begin{verbatim}
WIRE
wire_1   -1  +98.9   2.0  1.0   10.0   10.0     1.1     1.1
wire_2   -1  +98.9   2.0  1.0   10.0   10.0     0.0     0.0
NEXT
\end{verbatim}
The single and structure element definition in \verb|fort.2| is given by:
\begin{verbatim}
SINGLE ELEMENTS---------------------------------------------------------
...
wire_1           15   0.000000000e+00   0.000000000e+00 
0.000000000e+00    0.000000000e+00    0.000000000e+00    0.000000000e+00
wire_2           15   0.000000000e+00   0.000000000e+00 
0.000000000e+00    0.000000000e+00    0.000000000e+00    0.000000000e+00
...
STRUCTURE INPUT---------------------------------------------------------
...
BLOC56            wire_1              wire_2
...
\end{verbatim}
Note that all parameters except for the type have to be set to 0 in the single element definition.

\section{``Phase Trombone'' Element} \label{Trombone}

\subparagraph{Description} The linear ``phase trombone'' allows to
introduce a change in the tranverse phases without spoiling the linear
optics of the rest of the machine, i.e. the Twiss parameters are the
same at entrance and exit of the element.  
\subparagraph{Keyword} TROM
\subparagraph{Number of data lines} 1 line with name and then in
blocks of 14 lines with 3 entries each

\subparagraph{Format} 
\begin{itemize}
\item first data line: {\em name}
\item second data line: {\em cx, $cx'$, cy}
\item third data line: {\em $cy'$, cz, $cz'$}
\item fourth till $15^{th}$ {\em M($ 6 \times 6$)} matrix 
\end{itemize}

\begin{description}
\item [name] May contain up to sixteen characters
\item [cx, $cx'$, cy, $cy'$, cz, $cz'$] (floats) 6D closed orbit to be added
  to the coordinates.
\item [M($ 6 \times 6$)] (floats) $ 6 \times 6$ matrix elements
\end{description}

\subparagraph{Remark} The user has to make sure that the above stated
conditions are fulfilled. When using the $mad\_6t$~\cite{CONVERTOR}
converter from MAD8 to SixTrack this is guaranteed to be the case. Note
also that the crossterms between the transverse plains are not
considered for the time being.

\section{Beam Distribution EXchange (BDEX)}
\label{sec:BDEX}

\paragraph{Description}

The Beam Distribution EXchange allows an external program to read and modify the beam distribution in SixTrack.
This can be used for tracking part of the machine in an external program, for example for including physics processes that are normally not available in SixTrack.
Another possible use is for multi-bunch tracking, i.e.\ with an external program ``swapping'' the bunch at a some point in the ring.
This would be useful for studying (for example) beam loading, where the external program would read the position of a bunch in the cavity, use that to compute an update of the cavity voltage (which can be sent to SixTrack using DYNK FUN PIPE), swap the bunch with another one and track that to the cavity (still at ``physics turn'' 1, but ``SixTrack turn'' 2) etc.

Please note that BDEX is currently not supported in the checkpoint/restart version or in the collimation version.
Including BDEX in one of these versions results in a run-time error.

\paragraph{Keyword} BDEX

\paragraph{Number of data lines} variable

\paragraph{Format}
There are three types of statements possible in a BDEX block, listed below.
Additionally, lines starting with ``/'' are treated as comments and are ignored.

\subparagraph{ELEM} \emph{ELEM chanName elemName action}\\
This associates a given element with an already existing channel and an action.
The element must appear in the SINGLE ELEMENT block, and be of type 0 (marker).
The action indicates what should be done with the particle distribution when it reaches this element.
Currently, the only allowed action is ``1'', which means ``particle exchange'', i.e.\ output the beam distribution and read back another one at the same point.

\subparagraph{CHAN} \emph{CHAN chanName chanType \ldots}\\
This creates a new channel through which the BDEX can communicate.
Currently, the only implemented chanType is PIPE, however TCPIP is also foreseen.

For the PIPE type, the statement including arguments is \emph{CHAN PIPE inPipeName outPipeName format fileUnit}.
This uses a pair of UNIX FIFOs, through which SixTrack can comunicate with an external program.
When the channel is used, it sends a message on the outpipe, then waits for a reply with the new distribution over the inPipe.
The format is an integer used to indicate the output/input format, and is currently unused.
The fileUnit is the Fortran unit number that should be used to open the inPipe.
The outPipe is opened on the next unit, so both units fileUnit and fileUnit+1 must be free.

\subparagraph{DEBU}
This statement switches on extra ``debugging'' output from BDEX.
This can be useful if debugging the code or if debugging the input.

\paragraph{Communication protocols}
The communication protocols used by the different channel types are listed below:
\subparagraph{PIPE communication protocol}
When a pair of pipes are first initialized, a header ``\texttt{BDEX-PIPE !******************!}'' is written to the output pipe.
Then, when the tracking reaches an element which is marked as active for this channel, it writes another header like ``\texttt{BDEX TURN= 1 BEZ=ip1 I= 1 NAPX= 64}'', where \texttt{TURN} is the number of the current SixTrack turn, \texttt{BEZ} the name of the SINGLE ELEMENT, \texttt{I} the index of the STRUCTURE ELEMENT, and \texttt{NAPX} the number of particles to be written out.
After this follows \texttt{NAPX} lines with the particle information (one per particle), each line of the format \texttt{xv(1,j) yv(1,j) xv(2,j) yv(2,j) sigmv(j) ejv(j) ejfv(j) rvv(j) dpsv(j) oidpsv(j) dpsv1(j),nlostp(j)} where all but the last floating point numbers, the last being an integer.
Finally, it writes ``\texttt{BDEX WAITING...}'' to the output pipe, and waits for data on the input pipe.

The first line expected on the input pipe should be an integer containing the number of particles to write back.
If this integer is -1, the current particle distribution is kept.
Otherwise, a number of lines of the same format as with the output is expected.
After reading in the expected number of particles, the string ``\texttt{BDEX TRACKING...}'' is written to the output pipe and tracking is resumed.

\subparagraph{TCPIP communication protocol}
TCPIP is not yet implemented, as it would require an external library.
The FLUKA version implements this, we should make sure that we are compatible with their requirements and ideally their protocol.

\paragraph{Example}~\\

\todo[inline]{Example BDEX block, example manual usage, example minimal Python program (location or listing).}

\section{Electron lens} \label{sec:elen}

\paragraph{Description} The electron lens module serves for reading in the input parameters for different types of electron lenses. Each e-lens also needs to be added as single element in the list of single elements. Currently only the ideal hollow electron lens is implemented.

\paragraph{Keyword} ELEN

\paragraph{Number of data lines} variable

\paragraph{Format} \emph{name type thetamax r2 r2ovr1 offset\_x offset\_y flag\_entrance flag\_exit}
A description of the input parameters for the different e-lens types is given in Table~\ref{tab:elen}. Currently only the ideal hollow electron lens is implemented in SixTrack (type ANNULAR).
\begin{center}
	\begin{longtable}{|p{2.25cm} | p{2.0cm} p{1.0cm} p{9.0cm}|}
		%Note: \\* (with the star) used to inhibit page breaks in the middle of groups of the same type
		\caption{Input parameters for ELEN block.}
		\label{tab:elen} \\*
		\hline
		\rowcolor{blue!30}
		Type name & Arguments & unit & Description \\*
		\hline
		\endfirsthead
		
		\hline
		\rowcolor{blue!30}
		Type name & Arguments & unit & Description \\*
		%\hline
		\endhead
		
		\rowcolor{gray!15}
		\multicolumn{4}{|c|}{(The table continues on the next page)}\\*
		\hline
		\endfoot
		
		\hline
		\endlastfoot

		\hline
		\rowcolor{blue!15}
		\multicolumn{4}{|l|}{valid for all types} \\*
		
		& \emph{name} & - &
		Name of e-lens. Must be the same as in list of single elements.\\*
		
		& \emph{type} & - &
		type of electron lens. Available types are ANNULAR. \\*
		%\hline

		\hline
		\rowcolor{blue!15}
		\multicolumn{4}{|l|}{type specific parameters} \\*
		
		ANNULAR & \emph{thetamax} & mrad &
		Maximum kick. This equals the kick received at $r=r_2$ where $r_2$ is the outer radius of the electron lens.\\*
		& \emph{r2} & mm &
		Outer radius of e-lens.\\*
		& \emph{r2ovr1} & - &
		Outer radius/inner radius.\\*
		& \emph{offset\_x} & mm &
		horizontal offset of e-lens.\\*
		& \emph{offset\_y} & mm &
		vertical offset of e-lens.\\*
		& \emph{flag\_entrance} & - &
		enable bends at entrance of e-lens.\\*
		& \emph{flag\_exit} & - &
		enable bends at exit of e-lens (not yet implemented).\\*
	\end{longtable}
\end{center}

\paragraph{Remark} The user has to check that the e-lens defined in the ELEN block is also defined in the list of single elements and vice versa. All parameters except for the type (type 29) are ignored in the single element definition.
The implementation of the ANNULAR type (ideal hollow e-lens) has no explicit energy-dependency, except for the user defined parameter \emph{thetamax} (see \cite{sixphys}).

\paragraph{Example} In the following we give some examples for e-lens definitions.

\subparagraph{ANNULAR} This example defines two electron lenses hel1 and hel2. The input block in \verb|fort.3| is then given by:
\begin{verbatim}
ELEN
hel1 ANNULAR 4.920e-03 6.928 1.5 0 0 0 0
hel2 ANNULAR 4.920e-03 6.928 1.5 1.1547 2.3093 0 0
NEXT
\end{verbatim}
The single and structure element definition in \verb|fort.2| is given by:
\begin{verbatim}
SINGLE ELEMENTS---------------------------------------------------------
...
hel1            29   0.000000000e+00   0.000000000e+00 
   0.000000000e+00    0.000000000e+00    0.000000000e+00    0.000000000e+00
hel2            29   0.000000000e+00   0.000000000e+00   
   0.000000000e+00    0.000000000e+00    0.000000000e+00    0.000000000e+00
...
STRUCTURE INPUT---------------------------------------------------------
...
BLOC56            hel1              hel2
...
\end{verbatim}
Note that all parameters except for the type are set to 0 in the single element definition.

\section{Scattering} \label{sec:scatter}
\todo[inline]{This module is experimental! Use at your own risk; both the input format and physics implementation may change.}

\paragraph{Description}
The SCATTER module is a framework for scattering particles through Monte Carlo processes at various points in the machine.

\paragraph{Keyword} SCAT(TER)

\paragraph{Number of data lines} variable

\paragraph{Format}
There are several different main statement classes possible in a SCATTER block, listed below.
Furthermore, lines starting with ``/'' are treated as a comment and ignored

\subparagraph{DEBUG} \emph{DEBUG}\\
This statement switches on extra ``debugging'' output from SCATTER.
This can be useful if debugging the code or if debugging the input.

\subparagraph{ELEMent} \emph{ELEM elemname profile scaling gen1 (gen2, (gen3))}\\
This statements associates a PROfile and between one and 3\footnote{Controlled by the parameter \texttt{scatter\_maxGenELEM}.} GENerators with a SINGLE ELEMENT which must be of type 40, as described in Section~\ref{SCAT}.
The \texttt{scaling} argument, which is a floating point number, is used to scale the probability of an interaction.
This can be controlled through DYNK, for example in order to scale only at one specified turn.
The PROfile, GENerator(s), and single elements are referenced through their names, and for the GENerators and PROfile they must be defined above the ELEMent in the SCATTER block.

\subparagraph{PROfile} \emph{PRO name type (arguments)} \\
This statement defines a profile, that is a density profile and general properties of the targets which with the tracked particles are colliding.
Several different types are available:
\begin{description}
\item[PROfile type \texttt{FLAT}:]\emph{PRO name FLAT density[targets/cm$^2$] mass[MeV/c$^2$] momentum[MeV/c]}
\item[PROfile type \texttt{GAUSS1}:]\emph{PRO name GAUSS1 beamtot[particles] sigmaX[mm] sigmaY[mm] offsetX[mm] offsetY[mm]}
\begin{align}
    \rho(x,y) = \frac{N_{\mathrm{tot}}}{2\pi\sigma_x\sigma_y}
                \exp\left(-\frac{(x-\mu_x)^2}{2\sigma_x^2}\right)
                \exp\left(-\frac{(y-\mu_y)^2}{2\sigma_y^2}\right)
\end{align}
\end{description}

\subparagraph{GENerator} \emph{GEN name type (arguments)} \\
The generator block takes a name and a generator type input, followed by the parameters for the
generator type.
\begin{description}
\item[GENerator type \texttt{PPBEAMELASTIC}:] \emph{GEN name PPBEAMELASTIC a b1 b2 phi tmin (crossSection)}\\
Takes five or six input arguments, and generates the probability distribution given by
\begin{align}
    g(t) = \frac{1}{a_1^2}\frac{d\sigma}{dt} = e^{-b_1 t}+ 2ae^{-(b_1+b_2)t/2}\cos{\phi} + a^2e^{-b_2 t},
\end{align}
where the first expression is a soft scatter data fit, the third expression a hard scatter fit,
and the second expression is the interference. $a = a_2/a_1$ is the amplitudes of the expressions.
These are combined into the first four input arguments $a$, $b_1$, $b_2$, and $\phi$, as well as
$t_{min}$ which provides a cut-off limit.

The optional sixth argument defines a fixed cross section for the scattering probability.\\
\\
\noindent Input example with values for a fit to 13 TeV LHC.
\begin{verbatim}
    GEN  sc_thin     PPBEAMELASTIC 0.046 18.52 4.601 2.647 0.0 30e-27
\end{verbatim}
\end{description}

\subparagraph{SEED} \emph{SEED seed1 seed2}\\
This sets the seed of the internal RNG used by the SCATTER block \todo{Cite RANECU}.
Two integer seeds are required, for this block.
The \texttt{SEED} block is mandatory for the SCATTER block to work.
Note that when running several simulations, the seed settings must be varied between each run in order to get uncorrelated results.

